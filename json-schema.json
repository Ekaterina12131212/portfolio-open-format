{
    "$schema": "https://json-schema.org/draft/2020-12/schema",
    "$id": "https://portfolio-open-format.com/portfolio-1.1.0.json",
    "title": "Portfolio",
    "description": "Портфель инвестора",
    "type": "object",
    "properties": {
        "version": {
            "type": "string",
            "const": "1.1.0",
            "description": "Версия формата данных, в формате \"x.y.z\", в потоке байтов или в файле это поле должно встречаться первым в объекте"
        },
        "end": {
            "type": "integer",
            "minimum": 0,
            "description": "В формате unix timestamp. Дата время конца периода (включительно), который покрывается файлом с данными"
        },
        "start": {
            "type": "integer",
            "minimum": 0,
            "description": "В формате unix timestamp. Дата и время начала периода (включительно), который покрывается файлом с данными"
        },
        "generated": {
            "type": "integer",
            "minimum": 0,
            "description": "В формате unix timestamp. Дата и время создания"
        },
        "generated-by": {
            "type": "string",
            "description": "Наименование приложения, создавшего файл"
        },
        "accounts": {
            "type": "array",
            "items": {"$ref": "#/$defs/account"},
            "description": "Счета, встречающиеся в файле"
        },
        "assets": {
            "type": "array",
            "items": {"$ref": "#/$defs/asset"},
            "description": "Активы, встречающиеся в файле"
        },
        "cash-balances": {
            "type": "array",
            "items": {"$ref": "#/$defs/cash-balance"},
            "description": "Денежные остатки на конец периода, обозначенного в поле 'end'"
        },
        "trades": {
            "type": "array",
            "items": {"$ref": "#/$defs/trade"},
            "description": "Сделки за период, указанный в полях 'start' и 'end'. Если 'start' отсутствует, то с момента открытия самого первого счета"
        },
        "payments": {
            "type": "array",
            "items": {"$ref": "#/$defs/payment"},
            "description": "Выплаты, привязанные к активам, за период, указанный в полях 'start' и 'end'. Если 'start' отсутствует, то с момента открытия самого первого счета"
        }
    },
    "patternProperties": {
        "^vnd-": {
            "type": "object",
            "description": "Пример наименования поля 'vnd-abc'. Объект специфичный для ПО 'abc', где 'abc' - произвольное наименование приложения, выполняющего экспорт полей. Приложение ABC может менять состав полей на свое усмотрение, без согласования с другими участниками, поддерживающими формат"
        }
    },
    "required": [
        "version",
        "end",
        "generated",
        "generated-by",
        "accounts",
        "assets",
        "cash-balances",
        "trades",
        "payments"
    ],
    "$defs": {
        "account": {
            "type": "object",
            "description": "Счет",
            "properties": {
                "id": {
                    "type": "integer",
                    "minimum": 0,
                    "description": "Внутренний уникальный для данной выгрузки идентификатор счета"
                },
                "account-number": {
                    "type": "string",
                    "description": "Номер счёта в финансовой организации"
                },
                "valuation": {
                    "type": "number",
                    "description": "Оценка стоимости активов на конец периода, обозначенного в поле 'end'"
                },
                "valuation-currency": {
                    "$ref": "#/$defs/currency",
                    "description": "Cимвольный код валюты (ISO 4217)"
                }
            },
            "required": [
                "id",
                "type",
                "valuation",
                "valuation-currency"
            ]
        },
        "asset": {
            "type": "object",
            "description": "Актив",
            "properties": {
                "id": {
                    "type": "integer",
                    "minimum": 0,
                    "description": "Внутренний уникальный для данной выгрузки идентификатор актива"
                },
                "type": {
                    "type": "string",
                    "enum": ["stock", "etf", "bond", "adr", "gdr", "security", "futures", "option", "warrant", "derivative", "fx-contract", "money", "asset"],
                    "description": "Тип актива. Примечания: adr, gdr - депозитарные расписки; security - если тип один из следующих: stock, etf, bond, adr, gdr, но какой неизвестно точно; derivative - если тип один из деривативов, но неизвестно точно какой; fx-contract - контракт валютного рынка (например для USDRUB_TOM); money - если денежные средства учитываются в приложении как отдельный актив; asset - для остальных активов, для которых не подходит ни один тип из списка"
                },
                "symbol": {
                    "type": "string",
                    "description": "Тикер, краткое имя, для money - символьный код (ISO 4217)"
                },
                "name": {
                    "type": "string",
                    "description": "Наименование актива"
                },
                "isin": {
                    "type": "string",
                    "pattern": "^[A-Z]{2}[A-Z0-9]{9}[0-9]$",
                    "description": "ISIN"
                },
                "exchange": {
                    "type": "string",
                    "description": "Биржа, на которой торгуется бумага, например 'MOEX', 'NASDAQ', 'NYSE', 'TSX', 'LSE'"
                }
            },
            "required": [
                "id",
                "type"
            ],
            "allOf": [
                {
                    "anyOf": [
                        {"required": ["symbol"]},
                        {"required": ["name"]},
                        {"required": ["isin"]}
                    ]
                },
                {
                    "if": {
                        "properties": {"type": {"enum": ["futures", "option", "warrant", "derivative"]}}
                    },
                    "then": {
                        "required": ["symbol"]
                    }
                },
                {
                    "if": {
                        "properties": {"type": {"const": "money"}}
                    },
                    "then": {
                        "properties": {"symbol": {"pattern": "^[A-Z]{3}$"}},
                        "required": ["symbol"]
                    }
                }
            ]
        },
        "cash-balance": {
            "type": "object",
            "description": "Денежный остаток",
            "properties": {
                "account": {
                    "type": "integer",
                    "minimum": 0,
                    "description": "Идентификатор счета из раздела 'accounts'"
                },
                "cash": {
                    "type": "array",
                    "items": {"$ref": "#/$defs/cash"},
                    "description": "Остаток денежных средств в каждой валюте"
                }
            },
            "required": [
                "account",
                "cash"
            ]
        },
        "cash": {
            "type": "object",
            "description": "Остаток денежных средств в заданной валюте",
            "properties": {
                "value": {
                    "type": "number",
                    "description": "Остаток денежных средств"
                },
                "currency": {
                    "$ref": "#/$defs/currency",
                    "description": "Валюта"
                }
            },
            "required": [
                "value",
                "currency"
            ]
        },
        "trade": {
            "type": "object",
            "description": "Сделка",
            "properties": {
                "id": {
                    "type": "integer",
                    "minimum": 0,
                    "description": "Внутренний уникальный для данной выгрузки идентификатор сделки"
                },
                "trade-id": {
                    "type": "string",
                    "description": "Номер сделки в системе учета брокера"
                },
                "timestamp": {
                    "type": "integer",
                    "minimum": 0,
                    "description": "В формате unix timestamp. Дата и время заключения сделки, может отсутствовать, если есть 'settlement'"
                },
                "settlement": {
                    "type": "integer",
                    "minimum": 0,
                    "description": "В формате unix timestamp. Дата и время исполнения сделки (поставки), может отсутствовать, если есть 'timestamp'"
                },
                "account": {
                    "type": "integer",
                    "minimum": 0,
                    "description": "Идентификатор счета из раздела 'accounts'"
                },
                "asset": {
                    "type": "integer",
                    "minimum": 0,
                    "description": "Идентификатор актива из раздела 'assets'"
                },
                "count": {
                    "type": ["integer", "number"],
                    "description": "Количество. Для покупки - положительное число, для продажи - отрицательное. Может быть целым числом или вещественным для дробных акций"
                },
                "price": {
                    "type": "number",
                    "description": "Цена бумаги/контракта (за единицу) в валюте сделки, для облигации - без учета НКД, для деривативов поле может отсутствовать"
                },
                "accrued-interest": {
                    "type": "number",
                    "minimum": 0,
                    "description": "НКД одной облигации на момент сделки в валюте из поля 'currency' (обязательное для облигаций поле)"
                },
                "currency": {
                    "$ref": "#/$defs/currency",
                    "description": "Cимвольный код ISO 4217 валюты сделки (может отсутствовать, если поле 'price' и 'accrued-interest' отсутствуют)"
                },
                "quote": {
                    "type": "number",
                    "description": "Котировка дериватива (в пунктах) или облигации (в процентах). Для деривативов - обязательное поле, для облигаций - опциональное"
                },
                "fee": {
                    "type": "number",
                    "description": "Комиссия сделки. Для возврата комиссии использовать отрицательные значения"
                },
                "fee-currency": {
                    "$ref": "#/$defs/currency",
                    "description": "Символьный код ISO 4217 валюты комиссии"
                },
                "description": {
                    "type": "string",
                    "description": "Произвольный комментарий к сделке"
                }
            },
            "required": [
                "id",
                "trade-id",
                "account",
                "asset",
                "count",
                "fee",
                "fee-currency"
            ],
            "allOf": [
                {
                    "anyOf": [
                        {"required": ["timestamp"]},
                        {"required": ["settlement"]}
                    ]
                },
                {
                    "not": {
                        "properties": {"count": {"const": 0}}
                    }
                },
                {
                    "anyOf": [
                        {"required": ["price"]},
                        {"required": ["quote"]}
                    ]
                },
                {
                    "if": {
                        "anyOf": [
                            {"required": ["price"]},
                            {"required": ["accrued-interest"]}
                        ]
                    },
                    "then": {
                        "required": ["currency"]
                    }
                },
                {
                    "if": {
                        "required": ["accrued-interest"]
                    },
                    "then": {
                        "required": ["price"]
                    }
                }
            ]
        },
        "payment": {
            "type": "object",
            "description": "Выплата, привязанная к активу",
            "properties": {
                "id": {
                    "type": "integer",
                    "minimum": 0,
                    "description": "Внутренний уникальный для данной выгрузки идентификатор выплаты"
                },
                "payment-id": {
                    "type": "string",
                    "description": "Идентификатор выплаты в системе учета брокера"
                },
                "account": {
                    "type": "integer",
                    "minimum": 0,
                    "description": "Идентификатор счета из раздела 'accounts'"
                },
                "asset": {
                    "type": "integer",
                    "minimum": 0,
                    "description": "Идентификатор актива из раздела 'assets'"
                },
                "type": {
                    "type": "string",
                    "enum": ["dividend", "coupon", "bond-amortization", "variation-margin", "fee", "interest", "other"],
                    "description": "Тип выплаты. Амортизацию облигации нужно учитывать типом 'bond-amortization', но погашения облигации должны учитываться сделкой продажи в разделе 'trades'. Комиссия брокера, привязанная к бумаге, например депозитарная комиссия, должна учитываться типом 'fee'. Процентные доходы кроме купонов, например по банковским счетам, должны учитываться типом 'interest'. Если тип выплаты не попадает ни под один из типов из списка, то используйте тип 'other'"
                },
                "count": {
                    "type": ["integer", "number"],
                    "description": "Количество бумаг, по которым произведена выплата. Положительное или отрицательное число (например, для деривативов). Может быть целым числом или вещественным для дробных акций"
                },
                "timestamp": {
                    "type": "integer",
                    "minimum": 0,
                    "description": "В формате unix timestamp. Дата и время поступления денежных средств на счет"
                },
                "amount": {
                    "type": "number",
                    "description": "Сумма выплаты (до удержания налога). Для вариационной маржи может быть отрицательное число или ноль"
                },
                "currency": {
                    "$ref": "#/$defs/currency",
                    "description": "Символьный код (ISO 4217) валюты"
                },
                "tax": {
                    "type": "number",
                    "description": "Размер удержанного налога"
                },
                "tax-currency": {
                    "$ref": "#/$defs/currency",
                    "description": "Символьный код (ISO 4217) валюты"
                },
                "description": {
                    "type": "string",
                    "description": "Произвольный комментарий к выплате"
                }
            },
            "required": [
                "id",
                "account",
                "asset",
                "type",
                "count",
                "timestamp",
                "amount",
                "currency"
            ],
            "allOf": [
                {
                    "if": {
                        "properties": {"type": {"enum":  ["dividend", "coupon", "bond-amortization"]}}
                    },
                    "then": {
                        "properties": {
                            "count": {"exclusiveMinimum":  0},
                            "amount": {"exclusiveMinimum":  0}
                        }
                    }
                },
                {
                    "if": {
                        "required": ["tax"]
                    },
                    "then": {
                        "required": ["tax-currency"]
                    }
                }
            ]
        },
        "currency": {
            "type": "string",
            "pattern": "^[A-Z]{3}$",
            "description": "Cимвольный код валюты (ISO 4217)"
        }
    }
}